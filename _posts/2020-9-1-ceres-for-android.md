---
layout: post
title:  Build full feature Ceres Solver for Android 10
categories: [SLAM,Android]
---

If you ever tried to implement google Ceres solver on Android, you would know that ceres' official doc doesn't provide enough detail for the task. Although it won't take long before you can compile an "Eigen only" version following ceres' installation guide, you still wonder, if adding the suitesparse support can make a faster version. In this post I will record the process of building a SuiteSparse-enabled version of ceres for Android, and conduct a comparison of the "Eigen only" version and the SuiteSparse-enabled version in terms of solver efficiency. The post will be organized as follows:

- Cmake tips
- Solving dependencies
- Modify CMakeLists.txt files
- Run tests on Android phone
- Performance comparison

## Cmake tips

I benefit from this [post](https://pabloariasal.github.io/2018/02/19/its-time-to-do-cmake-right/) when I tried to pick up some knowledge about Cmake. The author also pointed me to find an awesome [video](https://www.youtube.com/watch?v=bsXLMQ6WgIk) introducing the general principles about Cmake. My take-away is that, no matter how complicated a cmake project seems, it's just a combination of **targets**, each having their own **properties** and dependency targets. The general principle will be for each cmake project, we only need to construct its bone structure as
```shell
cmake_minimum_required()
project()
add_executable()/add_library()
target_link_libraries()
target_include_directories()
```
And if the project depends on external projects, all we need is to find a way to import the **libs** and **includes** generated by those dependency projects such as **find_package()**, other optional flags like xxxPackage_Found and xxxPackage_VERSION etc. are just for conditional variations of the build process. 

## Solving dependencies

To build ceres solver following this post requires the following major modules:

- BLAS & LAPACK 

	QML-1.14.0 lp64 lib is used here. You can also choose other implementations like OpenBlas, Intel MKL... But it's always recommanded to use the vendor provided implementation.

- Eigen3
	
	In this case, it's mainly used for its data structures and as the dense solver. We don't use Eigen's sparse solver. 

- SuiteSparse

	Use ndk-build to build suitesparse for android 
```sh
	DIR="build"
	if [ -d "$DIR" ]; then
	  ### Take action if $DIR exists ###
	  echo "${DIR} directory exists, removing old build..."
	  cd build
	  rm -r *
	else
	  ###  Control will jump here if $DIR does NOT exists ###
	  echo "${DIR} directory not exists, create one..."
	  mkdir build
	  cd build
	fi

	cmake \
	-DANDROID_ABI=arm64-v8a \
	-DANDROID_NDK=/home/zhaoqun/Android/Sdk/ndk/21.1.6352462 \
	-DCMAKE_TOOLCHAIN_FILE=/home/zhaoqun/Android/Sdk/ndk/21.1.6352462/build/cmake/android.toolchain.cmake \
	-DANDROID_NATIVE_API_LEVEL=28 \
	-DCMAKE_BUILD_TYPE=Release \
	-DCMAKE_INSTALL_PREFIX=install \
	-DANDROID_STL=c++_shared \
	-DBUILD_SHARED_LIBS=ON \
	-DQML_LIBRARY=/home/zhaoqun/Desktop/sparse-solver/QML/1.4.0/arm64/ilp64/lib/libQML-1.4.0.so \
	..


	make -j8
	make install
```
- OpenMP

	We change ceres' default threading from cxx_thread to OpenMP. 

- Gflags(optional) 

	if you want to build the examples

## Modify CMakeLists.txt files

Refer to the code. 

## Run tests on Android phone

Copy all test executables, data files and the .so libs the test executables depend on to /data/local/tmp of the phone. The shared libs include: 

libc++_shared.so
libomp.so
libQML-1.4.0.so
libamd.so
libbtf.so
libcamd.so
libccolamd.so
libcholmod.so
libcolamd.so
libcxsparse.so
libgtest.so
libklu.so
libldl.so
libmv_bundle_adjuster
libmv_homography
libspqr.so
libtest_util.so
libumfpack.so
libceres.so

## Performance comparison

I compared two ceres solver versions, one using Eigen as the sparse solver, the other uses suitesparse as the sparse solver, and compare their executing times on ceres' example pose_graph_3d. 

| data set | SuiteSparse (time) | Eigen (time) |  
| ----     | ------------| -------------------|  
| sphere3D | 9.158805s   | 19.802575s |  
| torus3D  | 23.173427s  | 90.262423s  |  
| grid3D   | 214.044466s | > 30min didn't return  |  